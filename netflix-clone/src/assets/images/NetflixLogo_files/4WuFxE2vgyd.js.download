;/*FB_PKG_DELIM*/

__d("WAWebMexFetchNewsletterPollVotersJobQuery.graphql",[],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],b=[{alias:"voter_list",args:[{kind:"Variable",name:"input",variableName:"input"}],concreteType:"XWA2NewsletterPollVoterListResponse",kind:"LinkedField",name:"xwa2_newsletters_poll_voter_list",plural:!1,selections:[{alias:null,args:null,concreteType:"XWA2NewsletterPollOptionWithVoters",kind:"LinkedField",name:"votes",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"vote_hash",storageKey:null},{alias:null,args:null,concreteType:"XWA2NewsletterSubscriberConnection",kind:"LinkedField",name:"voter_list",plural:!1,selections:[{alias:null,args:null,concreteType:"XWA2NewsletterSubscriberEdge",kind:"LinkedField",name:"edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"action_time",storageKey:null},{alias:null,args:null,concreteType:"XWA2User",kind:"LinkedField",name:"node",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"WAWebMexFetchNewsletterPollVotersJobQuery",selections:b,type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"WAWebMexFetchNewsletterPollVotersJobQuery",selections:b},params:{id:"7760795133953302",metadata:{},name:"WAWebMexFetchNewsletterPollVotersJobQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("WAWebMexFetchNewsletterPollVotersJob",["WATimeUtils","WAWebMexClient","WAWebMexFetchNewsletterPollVotersJobQuery.graphql","WAWebNewsletterPollsVotesUtils","WAWebWidFactory","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h!==void 0?h:h=b("WAWebMexFetchNewsletterPollVotersJobQuery.graphql");function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.newsletterId,c=a.serverId,e=a.limit;a=a.voteHash;e={input:{limit:e,server_id:c.toString(10),newsletter_id:b,vote_hash:a}};c=(yield d("WAWebMexClient").fetchQuery(i,e));b=c.voter_list;return(e=b==null?void 0:(a=b.votes)==null?void 0:a.reduce(function(a,b){return a.set(d("WAWebNewsletterPollsVotesUtils").base64ToHex(b.vote_hash),(a=b.voter_list)==null?void 0:a.edges.map(k).filter(Boolean))},new Map()))!=null?e:new Map()});return j.apply(this,arguments)}function k(a){var b=a.node;a=a.action_time;b=b==null?void 0:b.id;if(b==null||a==null)return null;a=parseInt(a,10)/1e6;return{id:d("WAWebWidFactory").createWid(b),time:d("WATimeUtils").castToUnixTime(a)}}g["default"]=a}),98);
__d("WAWebSendCommentMessageActionUtils",["WATimeUtils","WAWebAck","WAWebCommentUtils","WAWebFrontendMsgGetters","WAWebMsgKey","WAWebMsgKeyUtils","WAWebMsgType","WAWebWidFactory","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){return d("WAWebCommentUtils").getEncCommentsFields(a,b,{conversation:c})});return h.apply(this,arguments)}function e(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){return d("WAWebCommentUtils").getEncCommentsFields(a,b,{extendedTextMessage:{text:c}})});return i.apply(this,arguments)}function f(a,b,c){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){a=d("WAWebFrontendMsgGetters").getChat(a);b=a.isGroup?d("WAWebWidFactory").toUserWid(b):void 0;a=new(c("WAWebMsgKey"))({id:yield c("WAWebMsgKey").newId(),remote:a.id,participant:b,fromMe:!0});return babelHelpers["extends"]({id:a},d("WAWebMsgKeyUtils").msgKeyToTargetInfo(a,d("WAWebMsgKeyUtils").TranslateMsgKeyType.Addon),{type:d("WAWebMsgType").MSG_TYPE.COMMENT,kind:d("WAWebMsgType").MsgKind.CommentEncrypted,t:d("WATimeUtils").unixTime(),addonEncrypted:!0,ack:d("WAWebAck").ACK.CLOCK},e)});return j.apply(this,arguments)}g.encryptConversationComment=a;g.encryptExtendedTextComment=e;g.createCommentMsgData=f}),98);
__d("WAWebSendCommentMessageAction",["WANullthrows","WAWebMsgDataFromModel","WAWebSendAddonMsgChatAction","WAWebSendCommentMessageActionUtils","WAWebUserPrefsMeUser","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=c("WANullthrows")(d("WAWebUserPrefsMeUser").getMaybeMeLidUser());a=(yield d("WAWebSendCommentMessageActionUtils").createCommentMsgData(a,e,yield d("WAWebSendCommentMessageActionUtils").encryptExtendedTextComment(d("WAWebMsgDataFromModel").msgDataFromMsgModel(a),e,b)));return d("WAWebSendAddonMsgChatAction").addAndSendAddonToChat(a)});return h.apply(this,arguments)}g.sendCommentMessage=a}),98);
__d("WAWebNewsletterPollVotersCache",["WATimeUtils","WAWebABProps","WAWebLruCacheMap"],(function(a,b,c,d,e,f,g){"use strict";var h=10,i=5e3,j=function(){function a(){this.$1=new(d("WAWebLruCacheMap").LruCacheMap)({sizeLimit:h})}a.isValidEntry=function(a){return a!=null&&d("WATimeUtils").unixTime()-a.timestamp<d("WAWebABProps").getABPropConfigValue("channels_poll_voters_summary_cache_ttl_ms")/1e3};var b=a.prototype;b.set=function(a,b){var c=d("WATimeUtils").unixTime();c={timestamp:c,votersMap:b};this.$1.set(a.toString(),c)};b.get=function(a){return this.$1.get(a.toString())};return a}(),k=function(){function a(){this.$1=new(d("WAWebLruCacheMap").LruCacheMap)({sizeLimit:i,getSize:function(a){return a.votersMap.size}})}var b=a.prototype;b.$2=function(a,b){return a.toString()+"-"+b};a.isValidEntry=function(a){return a!=null&&d("WATimeUtils").unixTime()-a.timestamp<d("WAWebABProps").getABPropConfigValue("channels_poll_voters_details_cache_ttl_ms")/1e3};b.set=function(a,b,c){var e=d("WATimeUtils").unixTime();e={timestamp:e,votersMap:b};this.$1.set(this.$2(a,c),e)};b.get=function(a,b){return this.$1.get(this.$2(a,b))};return a}(),l=new j(),m=new k();function a(a,b){if(b==null){var c=l.get(a),d=function(b){return l.set(a,b)};return j.isValidEntry(c)?[c,d]:[null,d]}c=m.get(a,b);d=function(c){return m.set(a,c,b)};return k.isValidEntry(c)?[c,d]:[null,d]}g.getPollVotersFromCache=a}),98);
__d("WAWebNewsletterFetchPollVotersAction",["WABase64","WALogger","WAWebApiContact","WAWebContactCollection","WAWebContactGetters","WAWebFindChatAction","WAWebMexFetchNewsletterPollVotersJob","WAWebNewsletterGatingUtils","WAWebNewsletterPollVotersCache","WAWebNewsletterValidationUtils","WAWebPollsCreateOptionLocalIdMap","WAWebWidFactory","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[newsletter][fetchPollVotersAction] failed to fetch poll voters for message ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[fetchPollVotersAction] cache miss, setting cache"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[fetchPollVotersAction] cache hit"]);j=function(){return a};return a}var k=5e3,l=5;function a(a){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.msg;a=a.pollVoteLocalId;try{var e=(yield d("WAWebFindChatAction").findChat(b.id.remote));if(!d("WAWebNewsletterGatingUtils").isNewsletterPollsVotersEnabledForChat(e))return;e=d("WAWebNewsletterPollVotersCache").getPollVotersFromCache(b.id,a);var f=e[0];e=e[1];if(f!=null){d("WALogger").DEV(j()).devConsole(f);return f.votersMap}var g=b.serverId,m=b.pollOptions;if(g==null||m==null)return;var o=(yield d("WAWebPollsCreateOptionLocalIdMap").createOptionLocalIdMap(m)),p=a!=null?o.getHashForLocalId(a):null;p=p!=null?d("WABase64").encodeB64(p):null;m=Math.max(m.length,1);a=a!=null?k:m*l;m=d("WAWebNewsletterValidationUtils").toNewsletterJidOrThrow(b.id.remote.toString());m=(yield c("WAWebMexFetchNewsletterPollVotersJob")({newsletterId:m,limit:a,serverId:g,voteHash:p}));a=new Map();for(g of m){p=g[0];m=g[1];a.set(o.getLocalIdForHexHash(p),n(m))}d("WALogger").DEV(i()).devConsole(f);e(a);return a}catch(a){d("WALogger").ERROR(h(),b.id.toString()).devConsole(a);return null}});return m.apply(this,arguments)}function n(a){var b=[],c=[];for(a of a){var e;e=(e=d("WAWebApiContact").getPhoneNumber(d("WAWebWidFactory").toUserWid(a.id)))!=null?e:a.id;e=d("WAWebContactCollection").ContactCollection.get(e);e!=null&&d("WAWebContactGetters").getIsMyContact(e)?b.push(babelHelpers["extends"]({},a,{contact:e})):c.push(babelHelpers["extends"]({},a,{contact:null}))}return{contacts:b.sort(o),others:c.sort(o)}}function o(a,b){return b.time-a.time}g.fetchPollVotersAction=a}),98);
__d("WAWebNewsletterSendVoteMsgAction",["WAAckLevel","WALogger","WATimeUtils","WAWebCRUDOperationsNewsletterMyVotes","WAWebFrontendMsgGetters","WAWebMsgCollection","WAWebMsgKey","WAWebMsgModel","WAWebMsgType","WAWebNewsletterBridgeApi","WAWebNewsletterPollVotesModelCollection","WAWebNewsletterPollsVotesUtils","WAWebNewsletterSendMessageJob","WAWebNewsletterUpdateMsgsRecordsJob","WAWebNewsletterValidationUtils","WAWebPollsActionsMetricUtils","WAWebPollsCreateOptionLocalIdMap","WAWebSchemaMessage","WAWebSendMsgResultAction","WAWebUserPrefsMeUser","WAWebWamEnumPollActionType","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[newsletter-polls] Failed to send poll vote"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[newsletter-polls] Deleting previous vote"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[newsletter-polls] Message missing serverId"]);j=function(){return a};return a}function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;b=(b=d("WAWebMsgCollection").MsgCollection.get(a.id))==null?void 0:b.safe();if(b==null)return d("WAWebSendMsgResultAction").SendMsgResult.ERROR_CANCELLED;var c=a.myVote;return b.type!==d("WAWebMsgType").MSG_TYPE.POLL_CREATION?d("WAWebSendMsgResultAction").SendMsgResult.ERROR_CANCELLED:l(b,c,a.msgKey)});return k.apply(this,arguments)}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=d("WAWebFrontendMsgGetters").getChat(a.unsafe()),f=d("WAWebNewsletterValidationUtils").toNewsletterJidOrThrow(e.id.toJid()),g=(yield d("WAWebPollsCreateOptionLocalIdMap").createOptionLocalIdMap(a.pollOptions)),k=Array.from(b).map(function(a){return new Uint8Array(g.getHashForLocalId(a))}),l=a.unsafe(),m=l.serverId;if(m==null){d("WALogger").WARN(j());return d("WAWebSendMsgResultAction").SendMsgResult.ERROR_CANCELLED}l=l.id;var o=d("WATimeUtils").castToMillisTime(d("WATimeUtils").unixTimeMs());c=(yield n({to:e.id,selectedOptionLocalIds:b,parentMsgKey:l,timestampMs:o,from:d("WAWebUserPrefsMeUser").getMeUser(),msgKey:c}));var q=new(d("WAWebMsgModel").Msg)(c),r=(yield d("WAWebCRUDOperationsNewsletterMyVotes").getMyVote(e.id.toJid(),m)),s=d("WAWebNewsletterPollVotesModelCollection").updateOrCreatePollVote({msgKey:c.id,parentMsgKey:l,selectedOptionLocalIds:b,timestamp:o});yield d("WAWebNewsletterBridgeApi").NewsletterBridgeApi.updateChatPreviewFromVote({voteMsgObj:{ack:c.ack,senderTimestampMs:c.senderTimestampMs,sender:d("WAWebUserPrefsMeUser").getMeUser(),read:!0,msgKey:c.id,parentMsgKey:l,selectedOptionLocalIds:c.selectedOptionLocalIds,t:c.t},parentMsgKey:l});try{yield d("WAWebNewsletterUpdateMsgsRecordsJob").addNewsletterMsgsRecords([c]);(r==null?void 0:r.msgKey)!=null&&(d("WALogger").DEV(i()).devConsole(r.msgKey),yield d("WAWebSchemaMessage").getMessageTable().remove(r.msgKey));yield d("WAWebCRUDOperationsNewsletterMyVotes").createOrUpdateMyVote({chatJid:e.id.toJid(),msgServerId:m,serverTimestampMs:o,votes:k.map(d("WAWebNewsletterPollsVotesUtils").bufferToHex),msgKey:q.id.toString()});l=(yield d("WAWebNewsletterSendMessageJob").sendNewsletterMessageJob({type:"pollVote",newsletterJid:f,msg:q,parentMsgServerId:m,votes:k}));d("WAWebPollsActionsMetricUtils").commitPollsActionsMetric({action:p(b,r),chat:d("WAWebFrontendMsgGetters").getChat(a.unsafe()),creationDateInSeconds:a.t,pollOptionsCount:a.pollOptions.length});switch(l.success){case!0:s.ack=d("WAAckLevel").ACK.SENT;q.updateAck(d("WAAckLevel").ACK.SENT);yield d("WAWebCRUDOperationsNewsletterMyVotes").updateMyVote({chatJid:e.id.toJid(),msgServerId:m,ack:d("WAAckLevel").ACK.SENT,t:l.ack.t});return d("WAWebSendMsgResultAction").SendMsgResult.OK;case!1:s.isSendFailure=!0;s.ack=d("WAAckLevel").ACK.FAILED;q.updateAck(d("WAAckLevel").ACK.FAILED);yield d("WAWebCRUDOperationsNewsletterMyVotes").updateMyVote({chatJid:e.id.toJid(),msgServerId:m,ack:d("WAAckLevel").ACK.FAILED,t:l.ack.t});return d("WAWebSendMsgResultAction").SendMsgResult.ERROR_NETWORK}}catch(a){q.updateAck(d("WAAckLevel").ACK.FAILED);s.isSendFailure=!0;yield d("WAWebCRUDOperationsNewsletterMyVotes").updateMyVote({chatJid:e.id.toJid(),msgServerId:m,ack:d("WAAckLevel").ACK.FAILED});d("WALogger").ERROR(h()).devConsole(a).tags("newsletter").sendLogs("newsletter-polls-failed-to-send-vote");throw a}});return m.apply(this,arguments)}function n(a){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.to,e=a.selectedOptionLocalIds,f=a.parentMsgKey,g=a.timestampMs,h=a.from;a=a.msgKey;return{from:h,type:d("WAWebMsgType").MSG_TYPE.POLL_UPDATE,kind:d("WAWebMsgType").MsgKind.PollVoteDecrypted,subtype:"poll_vote",id:(a=a)!=null?a:new(c("WAWebMsgKey"))({from:h,id:yield c("WAWebMsgKey").newId(),to:b}),t:Math.floor(g/1e3),pollUpdateParentKey:f,selectedOptionLocalIds:Array.from(e),senderTimestampMs:g,ack:d("WAAckLevel").ACK.CLOCK,to:b,read:!0}});return o.apply(this,arguments)}function p(a,b){return a.size===0?d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.REMOVE_VOTE:b==null?d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.VOTE:d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.CHANGE_VOTE}g.resendVote=a;g.sendVote=l}),98);
__d("WAWebPollsCreatePollUpdateVoteMsg",["WANullthrows","WAWebAck","WAWebAddOnEncryption","WAWebMsgGetters","WAWebMsgKeyUtils","WAWebMsgType","WAWebPollsProtobufConversion","WAWebReferentialMsgKey","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=self.crypto.getRandomValues(new Uint8Array(12)),f={type:"poll_vote",encode:yield d("WAWebPollsProtobufConversion").protobufFromVote(a,b.pollOptions)};f=(yield d("WAWebAddOnEncryption").encryptAddOn(f,{messageSecret:c("WANullthrows")(b.messageSecret,"Poll creation missing message secret"),iv:e,stanzaId:b.id.id,originalMessageSender:d("WAWebMsgGetters").getOriginalSender(b.unsafe()),addOnSender:a.sender}));var g=d("WAWebMsgKeyUtils").msgKeyToTargetInfo(a.msgKey,d("WAWebMsgKeyUtils").TranslateMsgKeyType.Addon),h=g.to;g=g.author;return{id:a.msgKey,type:d("WAWebMsgType").MSG_TYPE.POLL_UPDATE,kind:d("WAWebMsgType").MsgKind.PollVoteEncrypted,subtype:"poll_vote",addonEncrypted:!0,t:Math.floor(a.senderTimestampMs/1e3),from:a.sender,to:h,author:g,isNewMsg:!0,local:!0,ack:(h=a.ack)!=null?h:d("WAWebAck").ACK.CLOCK,pollUpdateParentKey:d("WAWebReferentialMsgKey").getReferentialMsgKey(b),encPollVote:{encPayload:f,encIv:e.buffer},senderTimestampMs:a.senderTimestampMs}});return h.apply(this,arguments)}g.createPollUpdateVoteMsg=a}),98);
__d("WAWebPollsUpsertVotesModelCollectionMsgAction",["WAAbortError","WAAckLevel","WALogger","WAWebAddonGatingUtils","WAWebAddonHydrationUtils","WAWebFrontendMsgGetters","WAWebMaxPerGroup","WAWebMsgCollection","WAWebMsgGetters","WAWebMsgType","WAWebNotificationBackend","WAWebNotificationHelpers","WAWebPollsGatingUtils","WAWebPollsGetVoteKey","WAWebPollsPollVoteCollection","WAWebUserPrefsMeUser","asyncToGeneratorRuntime","lodash"],(function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Aborted notification ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[upsertVotesModelCollection][notifications] Msg is not a pollCreationMsg"]);i=function(){return a};return a}function a(a,e,f){f===void 0&&(f=!0);var g=d("WAWebMaxPerGroup").maxPerGroup(a,function(a){return a.senderTimestampMs},d("WAWebPollsGetVoteKey").getVoteKey);e=(e||[]).map(function(a){return d("WAWebPollsPollVoteCollection").PollVoteCollection.getByMsgKey(a)}).filter(Boolean);var j=[];for(g of g){var k=d("WAWebPollsPollVoteCollection").PollVoteCollection.getForParentAddressingModeInsensitive([g.parentMsgKey]);k=k[0];k=k.getVoteFromSenderAddressingModeInsensitive(g.sender);if(k!=null&&(k.senderTimestampMs>g.senderTimestampMs||k.msgKey.equals(g.msgKey))){d("WAWebAddonGatingUtils").isUnifiedInfraEnabledForType(d("WAWebMsgType").MSG_TYPE.POLL_UPDATE)&&k.ack!==g.ack&&(k.ack=g.ack,k.isSendFailure=g.ack===d("WAAckLevel").ACK.FAILED);continue}k!=null&&e.push(k);j.push(d("WAWebPollsPollVoteCollection").createPollVoteModel(babelHelpers["extends"]({},g,{isSendFailure:f&&g.ack===d("WAAckLevel").ACK.CLOCK&&d("WAWebUserPrefsMeUser").isMeAccount(g.sender)})))}j.length>0&&d("WAWebPollsPollVoteCollection").PollVoteCollection.add(j);e.length>0&&d("WAWebPollsPollVoteCollection").PollVoteCollection.remove(e);d("WAWebPollsGatingUtils").arePollsNotificationsEnabled()&&b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(f||d("WAWebNotificationHelpers").isOfflineResumeInProgress())return;var b=c("lodash").uniqBy(a.filter(function(a){return!d("WAWebUserPrefsMeUser").isMeAccount(a.sender)}).map(function(a){return a.parentMsgKey}),String),e=(yield d("WAWebMsgCollection").MsgCollection.hydrateOrGetMessages(Array.from(b,String))).map(function(a){var b=d("WAWebFrontendMsgGetters").getAsPollCreation(a);b==null&&d("WALogger").ERROR(i()).sendLogs("msg-type-"+a.type+"-not-poll-creation-msg");return b}).filter(Boolean).filter(function(a){return d("WAWebMsgGetters").getIsSentByMe(a)});yield d("WAWebAddonHydrationUtils").hydrateAddons({ids:b,hydrationType:d("WAWebMsgType").MSG_TYPE.POLL_UPDATE});for(b of e){e=d("WAWebPollsPollVoteCollection").PollVoteCollection.getForParentAddressingModeInsensitive([b.id]);e=e[0];e.getUnreadCount()>0&&d("WAWebNotificationBackend").showPollVoteNotification(b)["catch"](d("WAAbortError").catchAbort(function(a){d("WALogger").LOG(h(),a)}))}})()}g.upsertVotesModelCollection=a}),98);
__d("WAWebPollsSendVoteMsgAction",["WAJobOrchestratorTypes","WALogger","WANullthrows","WATimeUtils","WAWebAck","WAWebAddOnsUpdateSendStatesAction","WAWebAddonDBTable","WAWebAddonGatingUtils","WAWebDBProcessMessage","WAWebFrontendMsgGetters","WAWebFrontendPollVoteGetters","WAWebLidMigrationUtils","WAWebMessageAddOnType","WAWebMessageSendPerfReporter","WAWebMessageSendReporter","WAWebMsgGetters","WAWebMsgKey","WAWebMsgKeyUtils","WAWebMsgModel","WAWebMsgType","WAWebNewsletterGatingUtils","WAWebNewsletterPollVotesModel","WAWebNewsletterSendVoteMsgAction","WAWebOrchestratorNonPersistedJob","WAWebPollsActionsMetricUtils","WAWebPollsCreatePollUpdateVoteMsg","WAWebPollsPollVoteCollection","WAWebPollsUpsertVotesModelCollectionMsgAction","WAWebPollsVoteDataUtils","WAWebProcessAddonsJob","WAWebReferentialMsgKey","WAWebSchemaMessage","WAWebSendAddonMsgChatAction","WAWebSendMsgRecordAction","WAWebSendMsgResultAction","WAWebWamEnumMediaType","WAWebWamEnumPollActionType","WAWebWid","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendVote: failed to store sent poll vote message into Message storage"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Newsletter polls are not supported yet"]);i=function(){return a};return a}function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(c("WAWebWid").isNewsletter(a.id.remote)){if(!d("WAWebNewsletterGatingUtils").isNewsletterPollsReceivingEnabled()){d("WALogger").ERROR(i());return}yield d("WAWebNewsletterSendVoteMsgAction").sendVote(a,b);return}yield n(a,b)});return j.apply(this,arguments)}function e(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a instanceof d("WAWebNewsletterPollVotesModel").NewsletterPollVotes){yield d("WAWebNewsletterSendVoteMsgAction").resendVote(a);return}yield n(d("WAWebFrontendPollVoteGetters").getParentMsg(a),new Set(a.selectedOptionLocalIds),a.msgKey)});return k.apply(this,arguments)}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){c=c==null?d("WATimeUtils").unixTimeMs():Math.max(c.senderTimestampMs+1,d("WATimeUtils").unixTimeMs());b=babelHelpers["extends"]({},b,{senderTimestampMs:c});return d("WAWebPollsCreatePollUpdateVoteMsg").createPollUpdateVoteMsg(b,a)});return m.apply(this,arguments)}function n(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){var g=d("WAWebFrontendMsgGetters").getChat(a.unsafe());g=d("WAWebLidMigrationUtils").getMeUserLidOrJidForChat(g,d("WAWebMsgKeyUtils").TranslateMsgKeyType.Addon);var i=a.id.remote,j=f!=null;f=(f=f)!=null?f:new(c("WAWebMsgKey"))({fromMe:!0,remote:i,id:yield c("WAWebMsgKey").newId(),participant:d("WAWebMsgGetters").getIsGroupMsg(a.unsafe())?g:void 0});var k=d("WAWebReferentialMsgKey").getReferentialMsgKey(a),m=d("WATimeUtils").unixTimeMs();f={msgKey:f,parentMsgKey:k,selectedOptionLocalIds:Array.from(e),senderTimestampMs:m,t:Math.floor(m/1e3),sender:g,ack:d("WAWebAck").ACK.CLOCK,read:!0};if(d("WAWebAddonGatingUtils").isUnifiedInfraEnabledForType(d("WAWebMsgType").MSG_TYPE.POLL_UPDATE)){m=d("WAWebPollsPollVoteCollection").PollVoteCollection.getForParentAddressingModeInsensitive([k])[0].getVoteFromSenderAddressingModeInsensitive(g);var n=(yield l(a,f,m));n=(yield d("WAWebSendAddonMsgChatAction").addAndSendAddonToChat(n));if(n.messageSendResult!==d("WAWebSendMsgResultAction").SendMsgResult.OK)throw c("err")("Vote send error");e.size>0?n=m?d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.CHANGE_VOTE:d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.VOTE:n=d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.REMOVE_VOTE;d("WAWebPollsActionsMetricUtils").commitPollsActionsMetric({action:n,chat:d("WAWebFrontendMsgGetters").getChat(a.unsafe()),creationDateInSeconds:a.t,pollOptionsCount:a.pollOptions.length});return}var o=new(d("WAWebMessageSendPerfReporter").MessageSendPerfReporter)({chatWid:a.id.remote,mediaType:d("WAWebWamEnumMediaType").MEDIA_TYPE.POLL_VOTE,messageType:a.getWamMessageType()});o.startRenderedStage();d("WAWebPollsUpsertVotesModelCollectionMsgAction").upsertVotesModelCollection([f],null,!1);o.postRenderedStage();m=d("WAWebPollsPollVoteCollection").PollVoteCollection.getForParentAddressingModeInsensitive([k]);n=m[0];m=c("WANullthrows")(n.getVoteFromSenderAddressingModeInsensitive(g));try{k=(n=(yield d("WAWebAddonDBTable").addonDBTable.bulkGetByParentAndSender(d("WAWebMsgType").MSG_TYPE.POLL_UPDATE,[[k,g]])))==null?void 0:n[0];var p;k&&k.kind===d("WAWebMsgType").MsgKind.PollVoteDecrypted&&(p=d("WAWebPollsVoteDataUtils").pollVoteMsgDataToVoteData(k));var q=(yield l(a,f,p));m.senderTimestampMs=q.senderTimestampMs;j&&(yield d("WAWebAddOnsUpdateSendStatesAction").updateAddOnSendStatesAction(new Map([[d("WAWebMessageAddOnType").MessageAddOnType.PollVote,[{msgKey:q.id.toString(),ack:d("WAWebAck").ACK.CLOCK,isSendFailure:!1}]]])));var r=new(d("WAWebMsgModel").Msg)(q);r.wamMessageSendReporter=new(d("WAWebMessageSendReporter").MessageSendReporter)(r);r.wamMessageSendPerfReporter=o;yield d("WAWebProcessAddonsJob").processPollUpdatesMsgsJob([q]);g=d("WAWebOrchestratorNonPersistedJob").createNonPersistedJob("sendMessage",b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!j){try{o.startSavedStage(),yield d("WAWebDBProcessMessage").storeMessages([q],i),o.postSavedStage()}catch(a){d("WALogger").ERROR(h()).verbose().devConsole(a).sendLogs("store-sent-poll-vote-msg-failed");throw a}p!=null&&(yield d("WAWebSchemaMessage").getMessageTable().remove(p.msgKey.toString()))}var a=(yield d("WAWebSendMsgRecordAction").sendMsgRecord(r));if(a.messageSendResult!==d("WAWebSendMsgResultAction").SendMsgResult.OK)throw c("err")("Vote send error");return a}),{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION});yield g.waitUntilCompleted();e.size>0?n=p?d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.CHANGE_VOTE:d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.VOTE:n=d("WAWebWamEnumPollActionType").POLL_ACTION_TYPE.REMOVE_VOTE;d("WAWebPollsActionsMetricUtils").commitPollsActionsMetric({action:n,chat:d("WAWebFrontendMsgGetters").getChat(a.unsafe()),creationDateInSeconds:a.t,pollOptionsCount:a.pollOptions.length})}catch(a){m.isSendFailure=!0;throw a}});return o.apply(this,arguments)}g.sendVote=a;g.resendVote=e}),98);